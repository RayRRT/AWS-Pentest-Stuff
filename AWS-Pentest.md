

<h2 align="center" id="index">Index</h2>


- [Unauthenticated Enumeration](#heading1)
  - [Dorks](#headingS)
  - [Cross-Account ("Unauthenticated") Reconnaissance](#heading3)
- [Authenticated Enumeration](#heading2)
  - [General enum ,basic commands](#headingB)
  - [General enum ,more deep commands](#headingM)
  - [S3 Commands](#heading3)
  - [EC2 Commands](#heading4)
  - [Lambda Commands](#heading5)
  - [Databases Commands](#heading6)
- [Tools](#headingT)
  - [Pacu](#pacu)
  - [Scoutsuit](#scoutsuite)


<br>

<h2 align="center" id="heading1">Unauthenticated Enumeration</h2>

Just try to find leaks with credentials/keys, or use cross-account policies in order to enumerate users/roles/services (you need the target account ID at least).

Resources:
- [aws-role-enumeration-iam](https://rhinosecuritylabs.com/aws/aws-role-enumeration-iam-p2/)
- [aws-iam-user-enumeration](https://rhinosecuritylabs.com/aws/aws-iam-user-enumeration/)
- [enumerating-services-in-aws-accounts](https://www.sidechannel.blog/en/enumerating-services-in-aws-accounts-in-an-anonymous-and-unauthenticated-manner/)
- This tool looks good and is referred in the posts, but I couldn't get work :(:( [Quiet-riot , An enumeration tool for scalable, unauthenticated validation of AWS..](
https://github.com/righteousgambit/quiet-riot)


<h2 align="center" id="headingS">Dorks</h2>

S3:

```

site:http://s3.amazonaws.com intitle:index.of.bucket
site:http://amazonaws.com inurl:".s3.amazonaws.com/"
site:.s3.amazonaws.com "Company"
intitle:index.of.bucket
site:http://s3.amazonaws.com intitle:Bucket loading
site:*.amazonaws.com inurl:index.html
site:s3.amazonaws.com filetype:sql
site:s3.amazonaws.com filetype:json
site:s3.amazonaws.com intext:"AccessKeyId"
site:s3.amazonaws.com ext:log

```

Creds/Keys:

```

filename:.bash_profile aws
rds.amazonaws.com password
filename:credentials aws_access_key_id
filename:credentials aws_secret_access_key

```

<h2 align="center" id="headingC"> Cross-Account ("Unauthenticated") Reconnaissance </h2>


Enumerate Users and Roles :

* Just create a bucket on your own aws account and apply a policy. By specifying a principal in the target account , you can determine if that principals exists. If setting the bucket policy succeeds you know the role exists. If it fails you know the role does not.
* You can enumerate users and roles.
* You can do it manually, or using Pacu (**iam__enum_roles** module), or using this script: https://github.com/Frichetten/enumate_iam_using_bucket_policy-
 


```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Example permissions",
            "Effect": "Deny",
            "Principal": {
                "AWS": "arn:aws:iam::TargetAccountID:role/role_name"
            },
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::*bucket you own*"
        }
    ]
}

```


<h2 align="center" id="heading2">Authenticated Enumeration
</h2>

To find possible ways to allow lateral movement between accounts, or escalation of privileges, it is important to list them:

* What permissions does my user have?
* Which groups does my user belong to? --> What policies are attached to that groups?
* What roles has my user assigned? --> What policies are attached to these roles?
* Can my user assume other roles?
* Can my user attach policies?


<h2 align="center" id="headingB">General enum, basic commands
</h2>

- Set AWS programmatic keys for authentication (use --profile= for a new profile)
```
aws configure
```
- Enumerate users:
```
aws iam list-users
```
* Enumerate all buckets
```
aws s3api list-buckets --query "Buckets[].Name"
```
* Enumerate Groups:
```
aws iam list-groups
```
* Enumerate IAM roles:
```
aws iam list-roles
```
* Enumerate  IAM policies:
```
aws iam list-policies
```
* Enumeate lambda layers:
```
aws lambda list-layers

```
* Enumerate VPCs:
```
aws ec2 describe-vpcs
```
* Enumerate WebApps:
```
aws deploy list-applications
```
* Instance Metadata Service URL:
```
curl http://169.254.169.254/latest/meta-data
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<IAM Role Name>
curl --proxy vulndomain.target.com:80 http://169.254.169.254/latest/meta-data/iam/security-credentials/ && echo
```


<h2 align="center" id="headingM">General enum, deep commands
</h2>

* Enumerate caller identity (whoami):
```
aws sts get-caller identity
```
* Enumerate login profile:
```
aws iam get-login-profile --user-name $user
```
* Enumerate Groups for that user:
```
aws iam list-groups-for-user --user-name $user
```
* Enumerate policies attached to that user:
```
aws iam list-attached-user-policies --user-name $user
```
* Enumerate  certificates for that user:
```
aws iam list-signing-certificates --user-name $user
```
* Enumerate SSH keys for that user:
```
aws iam list-ssh-public-keys --user-name $user
```
* Get SSH Keys details:
```
aws iam get-ssh-public-key --user-name &user --encoding PEM  
--ssh-public-key-id APKAUAWOPGE5M47NZEIT
```
* Check MFA devices for users:
```
aws iam list-virtual-mfa-devices
```
* Enumerate policies 
```
aws iam list-policies
```
* Enumerate group attached Policies:
```
aws iam list-group-policies --group-name ad-admin  
aws iam list-attached-group-policies --group-name ad-admin
```
* Searching for customer managed policies
```
aws iam list-policies --scope Local | grep -A2 PolicyName
```
* Check for policy details of ad-customer-managed-policy.
```
aws iam get-policy --policy-arn  
arn:aws:iam::276384657722:policy/ad-customer-managed-policy
```
* Get the policy version document to check permissions that the policy grants
```
aws iam get-policy-version --policy-arn  
arn:aws:iam::276384657722:policy/ad-customer-managed-policy --version-id v1
```
* Enumerate roles
```
aws iam list-roles
```
* Enumerate details for roles
```
aws iam get-role --role-name ad-loggingrole
```
* Enumerate policies attached to roles
```
aws iam list-attached-role-policies --role-name ad-loggingrole  
aws iam list-role-policies --role-name ad-loggingrole
```


<h2 align="center" id="heading3">S3 Enumeration</h2>

* List S3 Buckets:
```
aws s3api list-buckets
```

* Enumerate bucket objects:
```
aws s3api list-objects-v2 --bucket data-extractor-repo  
aws s3api list-objects --bucket file-uploader-saved-files
```
* Check if S3 bucket is public:
```
aws s3api get-public-access-block --bucket data-extractor-repo
```
* Download objects from tS3 bucket:
```
aws s3 cp s3://file-uploader-saved-files/flag
```
* Create a bucket:
```
aws s3api create-bucket --bucket my-bucket --region us-east-1
```  
* Enumerate Bucket Location:
```
aws s3api get-bucket-location --bucket data-extractor-repo
```
* Enumerate object versions:
```
aws s3api list-object-versions --bucket data-extractor-repo
```
* Enumerate bucket policy:
```
aws s3api get-bucket-policy --bucket insecurecorp-code --output text | python -m  
json.tool
```
* Enumerate buckets ACLs and object ACLs:
```
aws s3api get-bucket-acl --bucket file-uploader-saved-files  
aws s3api get-object-acl --bucket file-uploader-saved-files --key flag
```
* Modify bucket policy :
```
aws s3api put-bucket-policy --bucket $bucketName --policy file://policy.json
```
* Modify bucket ACL:
```
aws s3api put-bucket-acl --bucket  $bucketName --access-control-policy file://acl.json
```

<h2 align="center" id="heading4">EC2 Commands</h2>

* Enumerate information about all instances:
```
aws ec2 describe-instances
```
* Enumerate information about a specific region:
```
aws ec2 describe-instances --region $region
```
* Enumerate information about specific instance:
```
aws ec2 describe-instances --instance-ids $ID
aws ec2 describe-instance-attribute --attribute userData --region $region --instance-id $instanceId --query UserData.Value --output text > encodeddata; base64 --decode encodeddata
```
* Enumerate EC2 subnets:
```
aws ec2 describe-subnets
```
* Enumerate EC2 network interfaces:
```
aws ec2 describe-network-interfaces
```
* List DirectConnect (VPN) connections
```
aws directconnect describe-connections
```


<h2 align="center" id="heading5">Lambda Commands</h2>


* Enumerate lambda layers:
```
aws lambda list-layers
```
* Enumerate lambda layers versions and compatible runtimes:
```
aws lambda list-layer-versions --layer-name php-runtime
```
* Enumerate lambda layer version information:
```
aws lambda get-layer-version --layer-name php-runtime --version-number 2
```
* Enumerate lambda functions:
```
aws lambda list-functions
```
* Enumerate lambda function details:
```
aws lambda get-function --function-name $functionName
```
Enumerate events:
```
aws lambda list-event-source-mappings --function-name $functionName
```

<h2 align="center" id="heading6">Databases Commands</h2>

* Enumerate tables associated with the current account:
```
aws dynamodb list-tables
```
* Enumerate information about the table:
```
aws dynamodb describe-table --table-name $tableName
```
* Enumerate items and attributes in a table:
```
aws dynamodb scan --table-name $tableName
```
* Enumerate backup of a table:
```
aws dynamodb describe-backup --backup-arn $backupArn
```
* Add new table to your account:
```
aws dynamodb create-table --attribute-definitions --table-name --key-schema
```
* Edit an item attribute or adds new item to the table:
```
aws dynamodb update-item --table-name --key
```
* List AWS RDS (SQL)
```
aws rds describe-db-instances --region $regionName
```

<h2 align="center" id="headingT">Tools</h2>


<h2 align="center" id="pacu">Pacu</h2>

----------------------------------------------------------------

[Pacu](https://github.com/RhinoSecurityLabs/pacu)

- Import AWS keys for a specific profile
```
import_keys <profile name>
```
- Detect if keys are honey token keys
```
run iam__detect_honeytokens
```
- Enumerate account information and permissions
```
run iam__enum_users_roles_policies_groups
run iam__enum_permissions
whoami
```
- Check for privilege escalation
```
run iam__privesc_scan
```

----------------------------------------------------------------


<h2 align="center" id="scoutsuite">Scoutsuite</h2>

[Scoutsuite](https://github.com/nccgroup/ScoutSuite)

Scoutsuit vulns:

- Just a list of common ScoutSuite vulns and how to check them:

  * IAM:
    - [Cross-Account AssumeRole Policy Lacks External ID and MFA](https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/IAM/cross-account-access-lacks-external-id-and-mfa.html#)
    - [Lack of Key Rotation for (Active) Days](https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/IAM/access-keys-rotated-90-days.html#)
    - [User without MFA](https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/RTM/iam-user-sign-in-without-mfa.html)

  * EC2:
    - [EBS Snapshot Not Encrypted / EBS Snapshot Not Encrypted](https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/EBS/snapshot-encrypted.html#) 
    - [Potential Secret in Instance User Data](https://docs.bridgecrew.io/docs/bc_aws_secrets_1)

  * S3:
    - [All Actions Authorized to All Principals](https://docs.fugue.co/FG_R00211.html)
    - [Bucket Public Access Via Policy](https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/S3/s3-bucket-public-access-via-policy.html#)
